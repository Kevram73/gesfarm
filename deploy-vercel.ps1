# Script PowerShell pour d√©ployer GESFARM sur Vercel
Write-Host "üöÄ D√©ploiement de GESFARM sur Vercel avec gestion CORS..." -ForegroundColor Green

# V√©rifier si Node.js est install√©
if (!(Get-Command node -ErrorAction SilentlyContinue)) {
    Write-Host "‚ùå Node.js n'est pas install√©. Veuillez l'installer depuis https://nodejs.org" -ForegroundColor Red
    exit 1
}

# V√©rifier si Vercel CLI est install√©
if (!(Get-Command vercel -ErrorAction SilentlyContinue)) {
    Write-Host "üì¶ Installation de Vercel CLI..." -ForegroundColor Yellow
    npm install -g vercel
}

# V√©rifier si l'utilisateur est connect√© √† Vercel
try {
    vercel whoami | Out-Null
    Write-Host "‚úÖ Connect√© √† Vercel" -ForegroundColor Green
} catch {
    Write-Host "üîê Connexion √† Vercel..." -ForegroundColor Yellow
    vercel login
}

# V√©rifier si le fichier .env existe
if (!(Test-Path ".env")) {
    Write-Host "üìù Cr√©ation du fichier .env..." -ForegroundColor Yellow
    Copy-Item ".env.example" ".env"
}

# G√©n√©rer la cl√© d'application
Write-Host "üîë G√©n√©ration de la cl√© d'application..." -ForegroundColor Yellow
$appKey = php artisan key:generate --show
Write-Host "‚ö†Ô∏è  IMPORTANT: Copiez cette cl√© et ajoutez-la comme variable APP_KEY dans Vercel:" -ForegroundColor Red
Write-Host $appKey -ForegroundColor Cyan

# Installer les d√©pendances Composer
Write-Host "üì¶ Installation des d√©pendances Composer..." -ForegroundColor Yellow
composer install --no-dev --optimize-autoloader

# Optimiser l'application Laravel
Write-Host "‚ö° Optimisation de l'application..." -ForegroundColor Yellow
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Nettoyer le cache
Write-Host "üßπ Nettoyage du cache..." -ForegroundColor Yellow
php artisan cache:clear

# D√©ployer sur Vercel
Write-Host "üöÄ D√©ploiement sur Vercel..." -ForegroundColor Green
vercel --prod

Write-Host "‚úÖ D√©ploiement termin√©!" -ForegroundColor Green
Write-Host "üìã Prochaines √©tapes:" -ForegroundColor Cyan
Write-Host "1. Configurez les variables d'environnement dans Vercel:" -ForegroundColor White
Write-Host "   - APP_KEY: $appKey" -ForegroundColor Gray
Write-Host "   - DB_CONNECTION: mysql" -ForegroundColor Gray
Write-Host "   - DB_HOST: votre-h√¥te-base-de-donn√©es" -ForegroundColor Gray
Write-Host "   - DB_DATABASE: votre-nom-base-de-donn√©es" -ForegroundColor Gray
Write-Host "   - DB_USERNAME: votre-utilisateur" -ForegroundColor Gray
Write-Host "   - DB_PASSWORD: votre-mot-de-passe" -ForegroundColor Gray
Write-Host "2. Configurez votre base de donn√©es externe (PlanetScale, Railway, etc.)" -ForegroundColor White
Write-Host "3. Ex√©cutez les migrations:" -ForegroundColor White
Write-Host "   vercel env pull .env.local" -ForegroundColor Gray
Write-Host "   php artisan migrate --force" -ForegroundColor Gray
Write-Host "4. Testez votre API: https://votre-app.vercel.app/api/" -ForegroundColor White
Write-Host "5. Mettez √† jour l'URL de l'API dans votre frontend" -ForegroundColor White
