# üåê Configuration CORS - GESFARM

## ‚úÖ **Configuration Appliqu√©e**

### **Origines Autoris√©es**
- `http://localhost:3000` (d√©veloppement local)
- `http://localhost:3001` (d√©veloppement local alternatif)
- `http://127.0.0.1:3000` (d√©veloppement local)
- `http://127.0.0.1:3001` (d√©veloppement local alternatif)
- `http://62.171.181.213:3000` (votre serveur de production)
- `https://62.171.181.213:3000` (votre serveur de production HTTPS)

### **Patterns Autoris√©s**
- `/^https?:\/\/localhost:\d+$/` - Tous les ports localhost
- `/^https?:\/\/127\.0\.0\.1:\d+$/` - Tous les ports 127.0.0.1
- `/^https?:\/\/62\.171\.181\.213:\d+$/` - Tous les ports de votre serveur

---

## üîß **Fichiers Modifi√©s**

### **1. `config/cors.php`**
```php
'allowed_origins' => [
    'http://localhost:3000',
    'http://localhost:3001',
    'http://127.0.0.1:3000',
    'http://127.0.0.1:3001',
    'http://62.171.181.213:3000',
    'https://62.171.181.213:3000',
],
```

### **2. `app/Http/Middleware/HandleCors.php`**
- Middleware personnalis√© pour une meilleure gestion CORS
- Support des patterns d'URL
- Gestion des requ√™tes preflight OPTIONS

### **3. `app/Http/Kernel.php`**
- Middleware CORS enregistr√© globalement

---

## üöÄ **Commandes de Red√©marrage**

### **Pour Appliquer les Changements**
```bash
# Red√©marrer les conteneurs Docker
docker-compose restart

# Ou reconstruction compl√®te
docker-compose down
docker-compose build --no-cache
docker-compose up -d
```

### **V√©rifier la Configuration**
```bash
# V√©rifier les logs
docker-compose logs -f app

# Tester une requ√™te CORS
curl -H "Origin: http://62.171.181.213:3000" \
     -H "Access-Control-Request-Method: GET" \
     -H "Access-Control-Request-Headers: X-Requested-With" \
     -X OPTIONS \
     http://62.171.181.213:8000/api/dashboard
```

---

## üîç **Test de la Configuration CORS**

### **Test avec cURL**
```bash
# Test de requ√™te preflight
curl -X OPTIONS \
  -H "Origin: http://62.171.181.213:3000" \
  -H "Access-Control-Request-Method: GET" \
  -H "Access-Control-Request-Headers: Content-Type,Authorization" \
  -v \
  http://62.171.181.213:8000/api/dashboard
```

### **R√©ponse Attendue**
```
HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://62.171.181.213:3000
Access-Control-Allow-Methods: GET, POST, PUT, PATCH, DELETE, OPTIONS
Access-Control-Allow-Headers: Accept, Authorization, Content-Type, X-Requested-With, X-CSRF-TOKEN, X-XSRF-TOKEN, Origin
Access-Control-Allow-Credentials: true
Access-Control-Max-Age: 86400
```

---

## üõ†Ô∏è **Configuration Frontend**

### **Fichier `.env.local` (√† cr√©er)**
```env
NEXT_PUBLIC_API_URL=http://62.171.181.213:8000/api
NEXT_PUBLIC_APP_URL=http://62.171.181.213:3000
```

### **Configuration API (d√©j√† mise √† jour)**
```typescript
// lib/services/api.ts
const api = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL || "http://62.171.181.213:8000/api",
  withCredentials: true,
})
```

---

## üö® **D√©pannage**

### **Erreur CORS Persistante**
1. **V√©rifier les logs Laravel** :
   ```bash
   docker-compose logs app | grep -i cors
   ```

2. **V√©rifier la configuration** :
   ```bash
   docker-compose exec app php artisan config:show cors
   ```

3. **Nettoyer le cache** :
   ```bash
   docker-compose exec app php artisan config:clear
   docker-compose exec app php artisan cache:clear
   ```

### **Erreur "Access-Control-Allow-Origin"**
- V√©rifier que l'URL exacte est dans `allowed_origins`
- V√©rifier que le protocole (http/https) correspond
- V√©rifier que le port correspond

### **Erreur "Access-Control-Allow-Headers"**
- V√©rifier que tous les headers n√©cessaires sont dans `allowed_headers`
- V√©rifier que `Authorization` est inclus pour les requ√™tes authentifi√©es

---

## üìã **Checklist de V√©rification**

- [ ] ‚úÖ Configuration CORS mise √† jour
- [ ] ‚úÖ Middleware CORS enregistr√©
- [ ] ‚úÖ URL serveur ajout√©e aux origines autoris√©es
- [ ] ‚úÖ Frontend configur√© avec la bonne URL API
- [ ] ‚úÖ Conteneurs red√©marr√©s
- [ ] ‚úÖ Test CORS r√©ussi

---

## üîÑ **Prochaines √âtapes**

1. **Red√©marrer les conteneurs** pour appliquer les changements
2. **Tester l'API** depuis le frontend
3. **V√©rifier les logs** en cas d'erreur
4. **Ajouter d'autres domaines** si n√©cessaire

---

*Configuration mise √† jour le : 18 Septembre 2025*
