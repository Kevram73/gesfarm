# üö® Guide Erreur 502 Bad Gateway - GESFARM

## üîç **Diagnostic de l'Erreur 502**

### **Erreur Observ√©e**
```
POST http://62.171.181.213/api/login net::ERR_FAILED 502 (Bad Gateway)
```

### **Signification**
- **502 Bad Gateway** = Nginx ne peut pas communiquer avec le conteneur Laravel
- **net::ERR_FAILED** = La requ√™te n'atteint m√™me pas le serveur

---

## üö® **Causes Possibles**

### **1. Conteneur Laravel Non D√©marr√©**
- Le conteneur `gesfarm_app` n'est pas en cours d'ex√©cution
- Le conteneur crash au d√©marrage
- Probl√®me de d√©pendances (MySQL, Redis)

### **2. Probl√®me de R√©seau Docker**
- Les conteneurs ne peuvent pas communiquer entre eux
- Probl√®me de configuration r√©seau Docker
- Ports non expos√©s correctement

### **3. Probl√®me de Configuration Nginx**
- Nginx ne peut pas atteindre `app:9000`
- Configuration FastCGI incorrecte
- Timeouts trop courts

### **4. Probl√®me de Base de Donn√©es**
- MySQL non accessible
- Migrations non ex√©cut√©es
- Configuration de connexion incorrecte

---

## ‚úÖ **Solutions Appliqu√©es**

### **1. Configuration Nginx Renforc√©e**
```nginx
# Timeouts plus longs
fastcgi_connect_timeout 300s;
fastcgi_send_timeout 300s;
fastcgi_read_timeout 300s;

# Buffer settings
fastcgi_buffer_size 128k;
fastcgi_buffers 4 256k;
fastcgi_busy_buffers_size 256k;
```

### **2. Headers CORS dans Nginx**
```nginx
# Headers CORS pour les r√©ponses PHP
add_header 'Access-Control-Allow-Origin' '$http_origin' always;
add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS' always;
add_header 'Access-Control-Allow-Headers' 'Accept, Authorization, Content-Type, X-Requested-With, X-CSRF-TOKEN, X-XSRF-TOKEN, Origin, Access-Control-Request-Method, Access-Control-Request-Headers' always;
add_header 'Access-Control-Allow-Credentials' 'true' always;
add_header 'Vary' 'Origin' always;
```

---

## üöÄ **Actions de Correction**

### **Option 1: Script Automatique**
```bash
cd C:\Users\LENOVO\Documents\codes\gesfarm
chmod +x fix-502-error.sh
./fix-502-error.sh
```

### **Option 2: Correction Manuelle**

#### **√âtape 1: Diagnostic**
```bash
# V√©rifier l'√©tat des conteneurs
docker-compose ps

# V√©rifier les logs
docker-compose logs app
docker-compose logs nginx
docker-compose logs db
```

#### **√âtape 2: Red√©marrage Complet**
```bash
# Arr√™ter tous les conteneurs
docker-compose down

# Nettoyer les volumes et r√©seaux
docker-compose down --volumes --remove-orphans

# Reconstruire les images
docker-compose build --no-cache --pull

# Red√©marrer les services
docker-compose up -d
```

#### **√âtape 3: V√©rification**
```bash
# Attendre le d√©marrage
sleep 30

# V√©rifier le statut
docker-compose ps

# Tester la connectivit√©
docker-compose exec app php --version
docker-compose exec app php artisan migrate:status
```

---

## üîç **Diagnostic Avanc√©**

### **1. V√©rifier les Conteneurs**
```bash
# Statut d√©taill√©
docker-compose ps

# Informations sur les conteneurs
docker inspect gesfarm_app
docker inspect gesfarm_nginx
```

### **2. V√©rifier les R√©seaux**
```bash
# Lister les r√©seaux Docker
docker network ls

# Inspecter le r√©seau
docker network inspect gesfarm_gesfarm_network
```

### **3. V√©rifier les Volumes**
```bash
# Lister les volumes
docker volume ls

# Inspecter les volumes
docker volume inspect gesfarm_mysql_data
```

### **4. Test de Connectivit√©**
```bash
# Test depuis nginx vers app
docker-compose exec nginx ping app

# Test depuis app vers db
docker-compose exec app ping db

# Test de l'API
curl -I "http://62.171.181.213/api/dashboard"
```

---

## üõ†Ô∏è **Corrections Sp√©cifiques**

### **Si le Conteneur App Crash**
```bash
# V√©rifier les logs d'erreur
docker-compose logs app

# Acc√©der au conteneur en mode debug
docker-compose run --rm app bash

# V√©rifier les d√©pendances
docker-compose exec app composer install
docker-compose exec app php artisan key:generate
```

### **Si MySQL N'est Pas Accessible**
```bash
# V√©rifier MySQL
docker-compose exec db mysql -u gesfarm_user -p gesfarm

# R√©initialiser la base de donn√©es
docker-compose exec app php artisan migrate:fresh --seed
```

### **Si Nginx Ne Peut Pas Atteindre App**
```bash
# V√©rifier la configuration nginx
docker-compose exec nginx nginx -t

# Recharger la configuration nginx
docker-compose exec nginx nginx -s reload
```

---

## üìã **Checklist de V√©rification**

- [ ] ‚úÖ Conteneurs Docker en cours d'ex√©cution
- [ ] ‚úÖ R√©seau Docker fonctionnel
- [ ] ‚úÖ Base de donn√©es MySQL accessible
- [ ] ‚úÖ Conteneur Laravel r√©pond
- [ ] ‚úÖ Nginx peut communiquer avec app
- [ ] ‚úÖ Configuration CORS active
- [ ] ‚úÖ API accessible depuis l'ext√©rieur
- [ ] ‚úÖ Test CORS r√©ussi

---

## üö® **Si le Probl√®me Persiste**

### **1. V√©rifier les Ressources Syst√®me**
```bash
# V√©rifier l'utilisation de la m√©moire
docker stats

# V√©rifier l'espace disque
df -h
```

### **2. V√©rifier les Logs Syst√®me**
```bash
# Logs Docker
docker system events

# Logs du syst√®me
journalctl -u docker
```

### **3. Test avec un Conteneur Simple**
```bash
# Tester avec un conteneur nginx simple
docker run -d -p 8080:80 nginx:alpine
curl http://62.171.181.213:8080
```

---

## üìû **Support**

Si le probl√®me persiste apr√®s toutes ces √©tapes :

1. **Collecter les logs** : `docker-compose logs > logs.txt`
2. **V√©rifier les ressources** : CPU, RAM, espace disque
3. **Tester avec un conteneur simple**
4. **V√©rifier la configuration r√©seau du serveur**

---

*Guide de d√©pannage 502 mis √† jour le : 18 Septembre 2025*
