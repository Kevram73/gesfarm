# Script PowerShell pour tester la configuration Nginx CORS

Write-Host "üß™ Test de la configuration Nginx CORS..." -ForegroundColor Cyan

# Tester la configuration Nginx
Write-Host "üìã V√©rification de la syntaxe Nginx..." -ForegroundColor Yellow
$nginxTest = docker-compose exec nginx nginx -t

if ($LASTEXITCODE -eq 0) {
    Write-Host "‚úÖ Configuration Nginx valide" -ForegroundColor Green
    
    # Recharger la configuration Nginx
    Write-Host "üîÑ Rechargement de la configuration Nginx..." -ForegroundColor Yellow
    docker-compose exec nginx nginx -s reload
    
    Write-Host "‚úÖ Configuration Nginx recharg√©e" -ForegroundColor Green
} else {
    Write-Host "‚ùå Erreur dans la configuration Nginx" -ForegroundColor Red
    exit 1
}

# Tester les requ√™tes CORS
Write-Host "üß™ Test des requ√™tes CORS..." -ForegroundColor Yellow

Write-Host "1. Test OPTIONS preflight pour /api/login:" -ForegroundColor Cyan
try {
    $response1 = Invoke-WebRequest -Uri "http://localhost:8000/api/login" -Method OPTIONS -Headers @{
        "Origin" = "http://localhost:3000"
        "Access-Control-Request-Method" = "POST"
        "Access-Control-Request-Headers" = "Content-Type,Authorization"
    } -UseBasicParsing
    
    Write-Host "‚úÖ Test 1 r√©ussi" -ForegroundColor Green
    Write-Host "Headers de r√©ponse:" -ForegroundColor Cyan
    $response1.Headers | Format-Table
} catch {
    Write-Host "‚ùå Test 1 √©chou√©: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n2. Test OPTIONS preflight pour /sanctum/csrf-cookie:" -ForegroundColor Cyan
try {
    $response2 = Invoke-WebRequest -Uri "http://localhost:8000/sanctum/csrf-cookie" -Method OPTIONS -Headers @{
        "Origin" = "http://localhost:3000"
        "Access-Control-Request-Method" = "GET"
        "Access-Control-Request-Headers" = "Content-Type"
    } -UseBasicParsing
    
    Write-Host "‚úÖ Test 2 r√©ussi" -ForegroundColor Green
    Write-Host "Headers de r√©ponse:" -ForegroundColor Cyan
    $response2.Headers | Format-Table
} catch {
    Write-Host "‚ùå Test 2 √©chou√©: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n3. Test GET simple:" -ForegroundColor Cyan
try {
    $response3 = Invoke-WebRequest -Uri "http://localhost:8000/api/health" -Method GET -Headers @{
        "Origin" = "http://localhost:3000"
    } -UseBasicParsing
    
    Write-Host "‚úÖ Test 3 r√©ussi" -ForegroundColor Green
    Write-Host "Headers de r√©ponse:" -ForegroundColor Cyan
    $response3.Headers | Format-Table
} catch {
    Write-Host "‚ùå Test 3 √©chou√©: $($_.Exception.Message)" -ForegroundColor Red
}

Write-Host "`n‚úÖ Tests CORS termin√©s!" -ForegroundColor Green
