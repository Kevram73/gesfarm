name: Deploy Farm Manager to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Permet de dÃ©clencher manuellement

jobs:
  build:
    name: Build Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, bcmath, gd, zip, pdo_mysql
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: |
            composer.json
            composer.lock
            Dockerfile
            docker-compose.yml
            artisan
            app/
            bootstrap/
            config/
            database/
            public/
            resources/
            routes/
            storage/
            docker/

  deploy-files:
    name: Deploy Files to Server
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-files

      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H 72.60.188.146 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Create deployment directory on server
        run: |
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          mkdir -p /var/www/farm-manager
          ENDSSH

      - name: Copy files to server
        run: |
          # Copier les fichiers essentiels
          sshpass -p 'Alkashi13@@#' scp -o StrictHostKeyChecking=no \
            composer.json \
            composer.lock \
            Dockerfile \
            docker-compose.yml \
            artisan \
            root@72.60.188.146:/var/www/farm-manager/
          
          # Copier les dossiers
          sshpass -p 'Alkashi13@@#' scp -o StrictHostKeyChecking=no -r \
            app \
            bootstrap \
            config \
            database \
            public \
            resources \
            routes \
            storage \
            docker \
            root@72.60.188.146:/var/www/farm-manager/


      - name: Setup environment on server
        run: |
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          set -e
          cd /var/www/farm-manager
          
          # CrÃ©er le fichier .env
          cat > .env << 'ENVEOF'
          APP_NAME="Farm Manager"
          APP_ENV=production
          APP_KEY=
          APP_DEBUG=false
          APP_URL=http://72.60.188.146:4010

          LOG_CHANNEL=stack
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=localhost
          DB_PORT=3306
          DB_DATABASE=farmmanager
          DB_USERNAME=root
          DB_PASSWORD=Alkashi13!!!%

          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120

          REDIS_HOST=127.0.0.1
          REDIS_PASSWORD=null
          REDIS_PORT=6379

          MAIL_MAILER=smtp
          MAIL_HOST=mailpit
          MAIL_PORT=1025
          MAIL_USERNAME=null
          MAIL_PASSWORD=null
          MAIL_ENCRYPTION=null
          MAIL_FROM_ADDRESS="noreply@farm-manager.com"
          MAIL_FROM_NAME="Farm Manager"
          ENVEOF
          
          # CrÃ©er les dossiers nÃ©cessaires
          mkdir -p storage/framework/cache/data
          mkdir -p storage/framework/sessions
          mkdir -p storage/framework/views
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          
          # DÃ©finir les permissions
          chown -R www-data:www-data storage bootstrap/cache || true
          chmod -R 775 storage bootstrap/cache || true
          ENDSSH

  deploy-docker:
    name: Deploy with Docker
    runs-on: ubuntu-latest
    needs: deploy-files
    
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H 72.60.188.146 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Deploy with Docker Compose
        run: |
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          set -e
          cd /var/www/farm-manager
          
          # ArrÃªter les conteneurs existants
          docker-compose down || true
          
          # Reconstruire les images
          docker-compose build --no-cache
          
          # DÃ©marrer les conteneurs
          docker-compose up -d
          
          # Attendre que les services soient prÃªts
          echo "â³ Attente du dÃ©marrage des services..."
          sleep 15
          
          # VÃ©rifier le statut
          docker-compose ps
          ENDSSH

  setup-app:
    name: Setup Application
    runs-on: ubuntu-latest
    needs: deploy-docker
    
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H 72.60.188.146 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Install dependencies in container
        run: |
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          cd /var/www/farm-manager
          
          # Installer les dÃ©pendances Composer dans le conteneur
          docker-compose exec -T app composer install --no-dev --optimize-autoloader --no-interaction || true
          
          # GÃ©nÃ©rer la clÃ© d'application si nÃ©cessaire
          docker-compose exec -T app php artisan key:generate --force || true
          
          # Optimiser Laravel
          docker-compose exec -T app php artisan config:cache || true
          docker-compose exec -T app php artisan route:cache || true
          docker-compose exec -T app php artisan view:cache || true
          ENDSSH

      - name: Run database migrations
        continue-on-error: true
        run: |
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          cd /var/www/farm-manager
          
          # Attendre que la base de donnÃ©es soit prÃªte
          echo "â³ Attente de la base de donnÃ©es..."
          sleep 10
          
          # ExÃ©cuter les migrations
          docker-compose exec -T app php artisan migrate --force || echo "âš ï¸ Migrations dÃ©jÃ  Ã  jour ou erreur (non bloquant)"
          ENDSSH

  verify:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: setup-app
    
    steps:
      - name: Setup SSH
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H 72.60.188.146 >> ~/.ssh/known_hosts
          chmod 600 ~/.ssh/known_hosts

      - name: Verify deployment
        run: |
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          cd /var/www/farm-manager
          
          # VÃ©rifier que les conteneurs tournent
          if docker-compose ps | grep -q "Up"; then
            echo "âœ… Application dÃ©ployÃ©e avec succÃ¨s!"
            echo "ðŸŒ AccÃ©dez Ã : http://72.60.188.146:4010"
            echo "ðŸ—„ï¸  phpMyAdmin: http://72.60.188.146:8081"
          else
            echo "âŒ Les conteneurs ne sont pas en cours d'exÃ©cution"
            docker-compose ps
            docker-compose logs --tail 50
            exit 1
          fi
          ENDSSH

      - name: Deployment Success
        if: success()
        run: |
          echo "âœ… DÃ©ploiement rÃ©ussi!"
          echo "ðŸŒ Application disponible Ã : http://72.60.188.146:4010"
          echo "ðŸ—„ï¸  phpMyAdmin disponible Ã : http://72.60.188.146:8081"

      - name: Deployment Failed
        if: failure()
        run: |
          echo "âŒ DÃ©ploiement Ã©chouÃ©. VÃ©rifiez les logs ci-dessus."
          sshpass -p 'Alkashi13@@#' ssh -o StrictHostKeyChecking=no root@72.60.188.146 << 'ENDSSH'
          cd /var/www/farm-manager
          docker-compose logs --tail 100
          ENDSSH
